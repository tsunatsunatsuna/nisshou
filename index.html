<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>日照計算シミュレーター Pro v6</title>
    <style>
        :root {
            --sun-color: #dc2626; /* 日照：赤 */
            --shadow-color: #2563eb; /* 日陰：青 */
            --secondary: #64748b;
            --bg: #f1f5f9;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height: 1.6; color: #1e293b; background-color: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 950px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { font-size: 1.4rem; color: #0f172a; text-align: center; margin-bottom: 1.5rem; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; }
        .field { margin-bottom: 10px; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; display: flex; align-items: center; }
        input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        /* Tooltip Style (Safari/iOS 修正版) */
        .info-trigger { 
            margin-left: 8px; cursor: pointer; background: var(--secondary); color: white; 
            width: 22px; height: 22px; border-radius: 50%; display: inline-flex; 
            align-items: center; justify-content: center; font-size: 14px; 
            border: none; -webkit-appearance: none;
        }
        
        /* モーダル表示 */
        .info-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;
        }
        .info-modal {
            background: white; width: 90%; max-width: 450px; max-height: 85vh; 
            overflow-y: auto; padding: 20px; border-radius: 12px; position: relative;
        }
        .close-modal {
            display: block; width: 100%; padding: 10px; background: var(--secondary);
            color: white; text-align: center; border-radius: 6px; margin-top: 15px; text-decoration: none; font-weight: bold; border: none;
        }

        .info-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin-top: 10px; }
        .info-table th, .info-table td { border: 1px solid #eee; padding: 6px; text-align: left; }
        .info-table th { background: #f8fafc; }

        button.main-btn { width: 100%; padding: 15px; background: var(--shadow-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1rem; font-weight: bold; margin-top: 10px; }
        
        .tabs { display: flex; gap: 5px; margin-top: 20px; border-bottom: 2px solid #e2e8f0; }
        .tab-btn { padding: 10px 20px; border: none; background: none; cursor: pointer; color: var(--secondary); border-bottom: 2px solid transparent; flex: 1; }
        .tab-btn.active { color: var(--shadow-color); border-bottom: 2px solid var(--shadow-color); font-weight: bold; }

        .res-display { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 10px; }
        .res-item { background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 5px solid #ddd; }
        .res-item.sun-item { border-left-color: var(--sun-color); background: #fef2f2; }
        .res-item.shadow-item { border-left-color: var(--shadow-color); background: #eff6ff; }
        
        .res-val { font-size: 1.4rem; font-weight: bold; }
        .sun-text { color: var(--sun-color); }
        .shadow-text { color: var(--shadow-color); }
        .res-sub { font-size: 0.8rem; color: #64748b; margin-bottom: 5px; display: flex; align-items: center; }

        .table-wrapper { overflow-x: auto; margin-top: 10px; border: 1px solid #e2e8f0; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; background: white; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #e2e8f0; }
        .status-sun { color: var(--sun-color); font-weight: bold; }
        .status-shadow { color: var(--shadow-color); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>日照計算シミュレーター Pro v6</h1>

    <div class="card">
        <div class="grid">
            <div class="field">
                <label>日付設定</label>
                <select id="datePreset" onchange="toggleDateInput(this.value)">
                    <option value="winter">冬至 (12/22頃)</option>
                    <option value="spring">春分・秋分 (3/21頃)</option>
                    <option value="summer">夏至 (6/21頃)</option>
                    <option value="manual">手動で日付を選ぶ</option>
                </select>
                <input type="date" id="manualDate" style="display:none; margin-top:10px;">
            </div>
            <div class="field">
                <label>緯度 (東京: 35.7)</label>
                <input type="number" id="lat" value="35.7" step="0.1">
            </div>
            <div class="field">
                <label>
                    判定面の高さ (測定面)
                    <button class="info-trigger" onclick="openModal('obs')">?</button>
                </label>
                <input type="number" id="h_obs" value="6.5" step="0.1">
            </div>
            <div class="field">
                <label>建物高さ (m)</label>
                <input type="number" id="h_build" value="14.0" step="0.1">
            </div>
            <div class="field">
                <label>建物までの距離 (m)</label>
                <input type="number" id="dist" value="2.0" step="0.1">
            </div>
        </div>
        <button class="main-btn" onclick="calculate()">シミュレーション実行</button>
    </div>

    <div id="resultsArea" style="display:none;">
        <div class="card">
            <div class="res-display">
                <div class="res-item sun-item">
                    <div class="res-sub sun-text">日の出〜日没の合計日照時間</div>
                    <div class="res-val sun-text" id="res_total_sun">-- 分</div>
                    <div style="font-size: 0.75rem;" id="sun_range_text">--:-- 〜 --:--</div>
                </div>
                <div class="res-item shadow-item">
                    <div class="res-sub shadow-text">
                        8:00〜16:00の日陰時間
                        <button class="info-trigger" onclick="openModal('shadow')">?</button>
                    </div>
                    <div class="res-val shadow-text" id="res_8to16_shadow">-- 分</div>
                    <div style="font-size: 0.75rem;">日影規制の判定目安</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="tabs">
                <button class="tab-btn active" onclick="changeInterval(60, this)">1時間</button>
                <button class="tab-btn" onclick="changeInterval(30, this)">30</button>
                <button class="tab-btn" onclick="changeInterval(10, this)">10</button>
            </div>
            <div class="table-wrapper">
                <table id="detailTable">
                    <thead>
                        <tr>
                            <th>時刻</th>
                            <th>太陽高度</th>
                            <th>1階(2.0m)</th>
                            <th>2階(4.0m)</th>
                            <th id="th_custom" style="background:#f0f9ff;">指定面</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="infoOverlay" class="info-overlay" onclick="closeModal()">
    <div class="info-modal" onclick="event.stopPropagation()">
        <div id="modalContent"></div>
        <button class="close-modal" onclick="closeModal()">閉じる</button>
    </div>
</div>

<script>
    let currentInterval = 60;

    const modalData = {
        obs: `<strong>用途地域と測定面（判定面の高さ）</strong>
            <table class="info-table">
                <thead><tr><th>用途地域</th><th>測定面</th><th>想定位置</th><th>備考</th></tr></thead>
                <tbody>
                    <tr><td>第1,2種低層</td><td>1.5m</td><td>1階窓付近</td><td>低層住宅重視</td></tr>
                    <tr><td>第1,2種中高層</td><td>4m / 6.5m</td><td>2階 / 3階付近</td><td>自治体指定</td></tr>
                    <tr><td>第1,2種住居</td><td>4m / 6.5m</td><td>2階 / 3階付近</td><td>中高層想定</td></tr>
                    <tr><td>近隣商業・準工業</td><td>6.5m</td><td>2〜3階レベル</td><td>商業・産業用途</td></tr>
                    <tr><td>条例なし地域</td><td>4m / 6.5m</td><td>ケースバイケース</td><td>自治体判断</td></tr>
                </tbody>
            </table>`,
        shadow: `<strong>日影規制の許容影時間（冬至基準）</strong>
            <table class="info-table">
                <thead><tr><th>用途地域</th><th>距離ライン</th><th>測定面</th><th>許容時間</th></tr></thead>
                <tbody>
                    <tr><td rowspan="2">第1,2種低層</td><td>〜5m</td><td>1.5m</td><td>2時間以内</td></tr>
                    <tr><td>5〜10m</td><td>1.5m</td><td>3時間以内</td></tr>
                    <tr><td rowspan="2">第1種中高層</td><td>〜5m</td><td>4m</td><td>2.5時間以内</td></tr>
                    <tr><td>5〜10m</td><td>4m</td><td>3.5時間以内</td></tr>
                    <tr><td rowspan="2">住居・準住居</td><td>〜5m</td><td>6.5m</td><td>3時間以内</td></tr>
                    <tr><td>5〜10m</td><td>6.5m</td><td>4時間以内</td></tr>
                    <tr><td rowspan="2">近隣商業</td><td>〜5m</td><td>6.5m</td><td>4時間以内</td></tr>
                    <tr><td>5〜10m</td><td>6.5m</td><td>5時間以内</td></tr>
                </tbody>
            </table>`
    };

    function openModal(type) {
        document.getElementById('modalContent').innerHTML = modalData[type];
        document.getElementById('infoOverlay').style.display = 'flex';
    }
    function closeModal() { document.getElementById('infoOverlay').style.display = 'none'; }

    function toggleDateInput(val) {
        document.getElementById('manualDate').style.display = (val === 'manual') ? 'block' : 'none';
    }

    function getDeclination() {
        const preset = document.getElementById('datePreset').value;
        if (preset === 'winter') return -23.44;
        if (preset === 'summer') return 23.44;
        if (preset === 'spring') return 0;
        const dateVal = new Date(document.getElementById('manualDate').value);
        if (isNaN(dateVal)) return -23.44; 
        const start = new Date(dateVal.getFullYear(), 0, 0);
        const dayOfYear = Math.floor((dateVal - start) / (1000 * 60 * 60 * 24));
        return 23.44 * Math.sin(2 * Math.PI * (dayOfYear - 80) / 365.25);
    }

    function changeInterval(min, btn) {
        currentInterval = min;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        calculate();
    }

    function calculate() {
        const lat = parseFloat(document.getElementById('lat').value) * Math.PI / 180;
        const hBuild = parseFloat(document.getElementById('h_build').value);
        const dist = parseFloat(document.getElementById('dist').value);
        const hObsSelected = parseFloat(document.getElementById('h_obs').value);
        const delta = getDeclination() * Math.PI / 180;
        
        document.getElementById('th_custom').innerText = `指定(${hObsSelected}m)`;

        let cosH = -Math.tan(lat) * Math.tan(delta);
        cosH = Math.max(-1, Math.min(1, cosH));
        const sunriseHour = 12 - (Math.acos(cosH) * 180 / Math.PI / 15);
        const sunsetHour = 12 + (Math.acos(cosH) * 180 / Math.PI / 15);

        document.getElementById('sun_range_text').innerText = 
            `可視時間: ${formatTime(sunriseHour)} 〜 ${formatTime(sunsetHour)}`;

        let totalSunMinutes = 0;
        let shadow8to16Minutes = 0;
        const tbody = document.querySelector('#detailTable tbody');
        tbody.innerHTML = '';

        for (let m = 0; m <= 24 * 60; m += 10) {
            const hour = m / 60;
            const h_time = (hour - 12) * 15 * Math.PI / 180;
            const sinAlt = Math.sin(lat) * Math.sin(delta) + Math.cos(lat) * Math.cos(delta) * Math.cos(h_time);
            const alt = Math.asin(sinAlt);
            const altDeg = alt * 180 / Math.PI;

            const checkSun = (hObs) => {
                if (altDeg <= 0) return false;
                const relH = hBuild - hObs;
                if (relH <= 0) return true;
                return (relH / Math.tan(alt)) < dist;
            };

            const isSunSelected = checkSun(hObsSelected);
            if (altDeg > 0 && isSunSelected) totalSunMinutes += 10;
            if (hour >= 8 && hour <= 16 && altDeg > 0 && !isSunSelected) shadow8to16Minutes += 10;

            if (m % currentInterval === 0 && hour >= Math.floor(sunriseHour) && hour <= Math.ceil(sunsetHour)) {
                const isSun1F = checkSun(2.0);
                const isSun2F = checkSun(4.0);
                tbody.insertAdjacentHTML('beforeend', `<tr>
                    <td style="font-weight:bold;">${formatTime(hour)}</td>
                    <td>${altDeg > 0 ? altDeg.toFixed(1) + '°' : '日没'}</td>
                    <td class="${isSun1F ? 'status-sun' : 'status-shadow'}">${isSun1F ? '☀️ 日照' : '影'}</td>
                    <td class="${isSun2F ? 'status-sun' : 'status-shadow'}">${isSun2F ? '☀️ 日照' : '影'}</td>
                    <td class="${isSunSelected ? 'status-sun' : 'status-shadow'}" style="background:#f0f9ff;">${isSunSelected ? '☀️ 日照' : '影'}</td>
                </tr>`);
            }
        }

        document.getElementById('res_total_sun').innerText = totalSunMinutes + " 分";
        document.getElementById('res_8to16_shadow').innerText = shadow8to16Minutes + " 分";
        document.getElementById('resultsArea').style.display = 'block';
    }

    function formatTime(h) {
        const hh = Math.floor(h);
        const mm = Math.round((h % 1) * 60);
        return `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}`;
    }

    calculate();
</script>

</body>
</html>
